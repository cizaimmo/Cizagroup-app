<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CizaRide+ ‚Äî Commander une course</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui, Arial;background:#06142E;color:white}
#map{height:100%;width:100%}

/* BOTTOM SHEET */
.panel{
  position:fixed;
  bottom:0;left:0;
  width:100%;
  background:#0B1D3A;
  border-radius:26px 26px 0 0;
  padding:18px;
  box-shadow:0 -12px 30px rgba(0,0,0,.5);
  z-index:1000;
}

.panel h3{
  margin:0 0 12px;
  color:#F2B840;
  text-align:center;
}

.input{
  background:#06142E;
  border:1px solid rgba(255,255,255,.15);
  border-radius:18px;
  padding:14px;
  margin-bottom:10px;
  color:white;
  font-size:15px;
  width:100%;
}

button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:26px;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
}

.calc{background:#F2B840;color:#06142E}
.order{background:#00ff88;color:#06142E;margin-top:8px}

.result{
  margin-top:10px;
  font-size:15px;
  text-align:center;
}

.signature{
  text-align:center;
  font-size:11px;
  opacity:.6;
  margin-top:8px;
}
.signature b{color:#F2B840}
</style>
</head>

<body>

<div id="map"></div>

<!-- PANEL CLIENT -->
<div class="panel">
  <h3>üöó Commander une course</h3>

  <input id="from" class="input" placeholder="D√©part (ex : Kanyosha)">
  <input id="to" class="input" placeholder="Destination (ex : Rohero)">

  <button class="calc" onclick="calculate()">Calculer le prix</button>

  <div class="result" id="result"></div>

  <button class="order" id="orderBtn" style="display:none">
    üöï Commander la course
  </button>

  <div class="signature">
    Design signed by <b>CIZA GROUP</b>
  </div>
</div>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- üî• FIREBASE (AJOUT) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "TA_API_KEY",
  authDomain: "TON_PROJET.firebaseapp.com",
  projectId: "TON_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
/* ===============================
   MAP ‚Äî BURUNDI (BUJUMBURA)
================================ */
const map = L.map('map', {
  center: [-3.3822, 29.3644],
  zoom: 14,
  minZoom: 12,
  maxZoom: 18
});

L.tileLayer(
  'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
  { attribution:'¬© OpenStreetMap', maxZoom:19 }
).addTo(map);

map.setMaxBounds([
  [-4.5, 28.8],
  [-2.3, 30.9]
]);

let routeLine;

/* ===============================
   GEOCODING
================================ */
async function geocode(place){
  const r = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place+', Bujumbura, Burundi')}`
  );
  const d = await r.json();
  if(!d.length) throw "Lieu introuvable";
  return [parseFloat(d[0].lat), parseFloat(d[0].lon)];
}

/* ===============================
   CALCUL TRAJET + PRIX
================================ */
async function calculate(){
  const from = document.getElementById("from").value.trim();
  const to = document.getElementById("to").value.trim();
  if(!from || !to){
    alert("Veuillez entrer le d√©part et la destination");
    return;
  }

  try{
    const s = await geocode(from);
    const e = await geocode(to);

    const url =
      `https://router.project-osrm.org/route/v1/driving/`+
      `${s[1]},${s[0]};${e[1]},${e[0]}`+
      `?overview=full&geometries=geojson`;

    const res = await fetch(url).then(r=>r.json());
    const r0 = res.routes[0];

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.geoJSON(r0.geometry,{
      style:{color:"#F2B840",weight:5}
    }).addTo(map);

    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

    const km = (r0.distance/1000).toFixed(1);
    const price = 2000 + km*1000;

    /* üîë STOCKAGE POUR FIREBASE */
    window._lastKm = km;
    window._lastPrice = price;

    document.getElementById("result").innerHTML =
      `üìè ${km} km<br>üí∞ <b>${price.toLocaleString()} BIF</b>`;

    document.getElementById("orderBtn").style.display = "block";
  }catch(e){
    alert("Erreur de localisation. Essayez un quartier de Bujumbura.");
  }
}

/* ===============================
   COMMANDE R√âELLE (FIRESTORE)
================================ */
let currentRideId = null;

document.getElementById("orderBtn").onclick = async ()=>{
  try{
    const doc = await db.collection("rides").add({
      from: document.getElementById("from").value,
      to: document.getElementById("to").value,
      distance: window._lastKm,
      price: window._lastPrice,
      status: "waiting",
      driverId: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    currentRideId = doc.id;

    document.getElementById("result").innerHTML =
      "üöï Recherche d‚Äôun chauffeur‚Ä¶";

  }catch(e){
    alert("Erreur lors de la commande");
  }
};
</script>

</body>
</html>
