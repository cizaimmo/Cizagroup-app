<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CizaRide+ ‚Äî Commander une course</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  font-family:system-ui, Arial;
  background:#06142E;
  color:white;
}

/* ===============================
   MAP
================================ */
#map{
  position:absolute;
  inset:0;
  z-index:1;
}

/* ===============================
   FLOATING BUTTONS
================================ */
.fab-bar{
  position:fixed;
  bottom:140px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:14px;
  z-index:3000;
}

.fab{
  width:46px;
  height:46px;
  border-radius:50%;
  background:#06142E;
  border:2px solid #F2B840;
  color:#F2B840;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(0,0,0,.45);
}
.fab:active{transform:scale(.95)}

/* ===============================
   PANEL
================================ */
.panel{
  position:fixed;
  bottom:0;left:0;
  width:100%;
  background:#0B1D3A;
  border-radius:26px 26px 0 0;
  padding:18px;
  box-shadow:0 -12px 30px rgba(0,0,0,.5);
  z-index:2000;
}

.panel h3{
  margin:0 0 12px;
  color:#F2B840;
  text-align:center;
}

.input{
  background:#06142E;
  border:1px solid rgba(255,255,255,.15);
  border-radius:18px;
  padding:14px;
  margin-bottom:10px;
  color:white;
  font-size:15px;
  width:100%;
}

button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:26px;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
}

/* ===============================
   BUTTON STATES
================================ */
.calc{background:#F2B840;color:#06142E}
.order{background:#00ff88;color:#06142E;margin-top:8px}

.loading{
  pointer-events:none;
  position:relative;
  opacity:.85;
}
.loading::after{
  content:"";
  width:22px;
  height:22px;
  border:3px solid rgba(6,20,46,.25);
  border-top:3px solid #06142E;
  border-radius:50%;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  animation:spin .8s linear infinite;
}

@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

/* ===============================
   SEARCH DRIVER
================================ */
.searching{
  margin-top:10px;
  text-align:center;
  font-size:14px;
  color:#F2B840;
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{opacity:.4}
  50%{opacity:1}
  100%{opacity:.4}
}

.signature{
  text-align:center;
  font-size:11px;
  opacity:.6;
  margin-top:8px;
}
.signature b{color:#F2B840}
</style>
</head>

<body>

<div id="map"></div>

<!-- üîô üîÑ -->
<div class="fab-bar">
  <div class="fab" onclick="location.href='portail.html'">‚Üê</div>
  <div class="fab" onclick="location.reload()">‚ü≥</div>
</div>

<!-- PANEL -->
<div class="panel">
  <h3>üöó Commander une course</h3>

  <input id="from" class="input" placeholder="D√©part (ex : Bwiza)">
  <input id="to" class="input" placeholder="Destination (ex : Rohero)">

  <button class="calc" id="calcBtn" onclick="calculate()">Calculer le prix</button>

  <div id="result" class="result"></div>

  <button class="order" id="orderBtn" style="display:none">
    üöï Commander la course
  </button>

  <div id="searching" class="searching" style="display:none">
    üîç Recherche d‚Äôun chauffeur‚Ä¶
  </div>

  <div class="signature">
    Design signed by <b>CIZA GROUP</b>
  </div>
</div>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"REMPLACE_ICI",
  authDomain:"REMPLACE_ICI.firebaseapp.com",
  projectId:"REMPLACE_ICI"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* MAP */
const map=L.map("map",{center:[-3.3822,29.3644],zoom:14});
L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
let routeLine;

/* GEO */
async function geocode(p){
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${p}, Bujumbura`);
  const d=await r.json(); if(!d.length) throw 0;
  return [d[0].lat,d[0].lon];
}

/* CALCUL */
async function calculate(){
  const btn=document.getElementById("calcBtn");
  const from=fromInput.value.trim();
  const to=toInput.value.trim();
  if(!from||!to) return alert("Remplissez les champs");

  btn.classList.add("loading");
  btn.textContent="Calcul en cours‚Ä¶";

  try{
    const s=await geocode(from), e=await geocode(to);
    const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${s[1]},${s[0]};${e[1]},${e[0]}?overview=full&geometries=geojson`).then(r=>r.json());
    const r0=r.routes[0];

    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(r0.geometry,{style:{color:"#F2B840",weight:5}}).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[30,30]});

    const km=(r0.distance/1000).toFixed(1);
    const price=Math.round(2000+km*1000);
    window._ride={from,to,km,price};

    result.innerHTML=`üìè ${km} km<br>üí∞ <b>${price.toLocaleString()} BIF</b>`;
    orderBtn.style.display="block";
  }catch{
    alert("Erreur localisation");
  }

  btn.classList.remove("loading");
  btn.textContent="Calculer le prix";
}

/* COMMANDE */
orderBtn.onclick=async()=>{
  searching.style.display="block";
  await db.collection("rides").add({
    ...window._ride,
    status:"waiting",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
};
</script>

</body>
</html>
