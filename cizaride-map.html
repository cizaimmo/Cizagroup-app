<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>CizaRide+ ‚Äî Carte & Distance</title>
<link rel="icon" href="logotransparent.png">

<!-- Leaflet (Carte) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body{
        margin:0;
        background:#06142E;
        font-family:Arial, sans-serif;
        color:white;
        overflow-x:hidden;
    }

    /* HEADER */
    header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:15px 18px;
        background:rgba(255,255,255,0.06);
        border-bottom:2px solid #F2B840;
        backdrop-filter:blur(10px);
        position:sticky;
        top:0;
        z-index:999;
    }
    header img{
        width:50px;
    }
    header button{
        background:#F2B840;
        border:none;
        color:#06142E;
        padding:8px 14px;
        font-weight:bold;
        border-radius:8px;
        cursor:pointer;
    }

    /* CARTE */
    #map{
        height:60vh;
        width:100%;
        margin-top:10px;
        border:3px solid #F2B840;
        border-radius:14px;
        overflow:hidden;
        box-shadow:0 0 20px rgba(242,184,64,0.35);
    }

    /* FORM */
    .box{
        width:90%;
        margin:20px auto;
        background:rgba(255,255,255,0.05);
        padding:20px;
        border-radius:16px;
        border:1px solid rgba(242,184,64,0.4);
        backdrop-filter:blur(12px);
    }
    input{
        width:100%;
        margin-top:10px;
        padding:12px;
        border-radius:10px;
        border:none;
        background:#0B1C35;
        color:white;
    }

    /* BUTTONS */
    .btn{
        background:#F2B840;
        color:#06142E;
        padding:12px;
        margin-top:15px;
        width:100%;
        border:none;
        border-radius:12px;
        font-weight:bold;
        cursor:pointer;
    }

    .result{
        margin-top:15px;
        padding:12px;
        background:rgba(255,255,255,0.1);
        border-left:3px solid #F2B840;
        border-radius:10px;
    }

    /* MULTILINGUE */
    .lang-btn{
        position:fixed;
        bottom:20px;
        right:20px;
        background:#F2B840;
        color:#06142E;
        border:none;
        padding:12px 16px;
        border-radius:50px;
        cursor:pointer;
        z-index:999;
    }
</style>
</head>

<body>

<header>
    <img src="logotransparent.png">
    <button onclick="history.back()">‚Üê Retour</button>
</header>

<div id="map"></div>

<div class="box">
    <input id="depart" type="text" placeholder="Point de d√©part" data-fr="Point de d√©part" data-en="Pickup location">
    <input id="arrivee" type="text" placeholder="Destination" data-fr="Destination" data-en="Destination">

    <button class="btn" onclick="calculerDistance()" 
        data-fr="Calculer la distance" data-en="Calculate Distance">
        Calculer la distance
    </button>

    <div id="result" class="result" style="display:none;"></div>

    <button class="btn" style="margin-top:10px;background:#35ff85;" onclick="payer()" 
        data-fr="Continuer vers Paiement" data-en="Proceed to Payment">
        Continuer vers Paiement
    </button>
</div>

<button class="lang-btn" onclick="switchLang()">FR</button>

<script>
/* üåç CARTE BLEU MARINE STYLE */
var map = L.map('map').setView([-3.38, 29.38], 13); // Bujumbura centre

L.tileLayer('https://api.maptiler.com/maps/streets-v2-dark/{z}/{x}/{y}.png?key=Znj...demo', {
    attribution: '¬© MapTiler ¬© OpenStreetMap',
}).addTo(map);

/* üöó MARQUEURS */
let markerDepart, markerArrivee, routeLayer;

/* üîç NOM ‚Üí COORDONN√âES (GEOCODING GRATUIT) */
async function geocode(adresse){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adresse)}`;
    const data = await (await fetch(url)).json();
    return data.length ? [data[0].lat, data[0].lon] : null;
}

/* üî• CALCUL DISTANCE */
async function calculerDistance(){
    const depart = document.getElementById("depart").value;
    const arrivee = document.getElementById("arrivee").value;

    if(!depart || !arrivee){
        alert("Veuillez remplir les deux champs.");
        return;
    }

    const dep = await geocode(depart);
    const arr = await geocode(arrivee);

    if(!dep || !arr){
        alert("Lieu introuvable.");
        return;
    }

    if(markerDepart) markerDepart.remove();
    if(markerArrivee) markerArrivee.remove();
    if(routeLayer) routeLayer.remove();

    markerDepart = L.marker(dep).addTo(map);
    markerArrivee = L.marker(arr).addTo(map);

    /* TRA√áAGE DE ROUTE (ligne OR anim√©e) */
    routeLayer = L.polyline([dep, arr], {
        color:"#F2B840",
        weight:5,
        opacity:0.9
    }).addTo(map);

    map.fitBounds(routeLayer.getBounds(), {padding:[40,40]});

    /* DISTANCE (km) */
    const R = 6371;
    const dLat = (arr[0]-dep[0]) * Math.PI/180;
    const dLon = (arr[1]-dep[1]) * Math.PI/180;

    const a = Math.sin(dLat/2)**2 + Math.cos(dep[0]*Math.PI/180)*Math.cos(arr[0]*Math.PI/180)*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;

    document.getElementById("result").style.display="block";
    document.getElementById("result").innerHTML =
        `<b>Distance :</b> ${distance.toFixed(2)} km<br>
         <b>Dur√©e estim√©e :</b> ${(distance/35*60).toFixed(0)} min`; // 35 km/h urbain
}

/* üé´ Paiement (placeholder) */
function payer(){
    alert("Syst√®me de paiement : Lumicash, Ecocash, Visa, Mastercard (cl√© √† ajouter)");
}

/* üåê LANG SWITCH */
function switchLang(){
    const html=document.documentElement;
    html.lang = html.lang === "fr" ? "en" : "fr";
    document.querySelector(".lang-btn").innerHTML = html.lang === "fr" ? "FR" : "EN";

    document.querySelectorAll("[data-fr]").forEach(el=>{
        el.innerHTML = html.lang==="fr" ? el.getAttribute("data-fr") : el.getAttribute("data-en");
    });
}
</script>

</body>
</html>
